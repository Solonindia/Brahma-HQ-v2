<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brahma HQ - PDF Upload</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
    }

    button.primary {
      background: #111;
      color: #fff;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    .status {
      white-space: pre-wrap;
      background: #f7f7f7;
      padding: 12px;
      border-radius: 10px;
      min-height: 140px;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .small {
      font-size: 12px;
      color: #555;
    }
  </style>
</head>

<body>

<h2>Brahma HQ ‚Äî Module Datasheet Upload</h2>

<div class="card">

  <div class="row">
    <div>
      <label>API Base URL</label>
      <input id="apiBase" placeholder="Leave blank if same server" />
      <div class="small">Example: https://your-uploader.run.app</div>
    </div>

    <div>
      <label>Bearer Token (optional)</label>
      <input id="token" placeholder="Paste token if required" />
    </div>
  </div>

  <label>Manufacturer (required)</label>
  <input id="mfr" placeholder="Example: JinkoSolar" />

  <div class="row">
    <div>
      <label>Series</label>
      <input id="series" placeholder="Example: Tiger Neo 72HL4-BDV" />
    </div>
    <div>
      <label>Model</label>
      <input id="model" placeholder="Example: JKM580N-72HL4-BDV" />
    </div>
  </div>

  <label>Select PDF</label>
  <input id="file" type="file" accept="application/pdf" />

  <label>Notes (optional)</label>
  <textarea id="notes" rows="3"></textarea>

  <div style="margin-top:15px;">
    <button id="uploadBtn" class="primary" onclick="startUpload()">Upload PDF</button>
  </div>

</div>

<div class="card">
  <h3>Status</h3>
  <div id="status" class="status">Ready.</div>
</div>

<script>
function setBusy(isBusy) {
  const btn = document.getElementById("uploadBtn");
  btn.disabled = isBusy;
  btn.textContent = isBusy ? "Uploading..." : "Upload PDF";
}

function log(msg) {
  const box = document.getElementById("status");
  box.textContent += "\n" + msg;
}

function resetStatus() {
  const box = document.getElementById("status");
  box.textContent = "Starting upload...";
}

function apiUrl(path) {
  const base = document.getElementById("apiBase").value.trim();
  if (!base) return path;
  return base.replace(/\/$/, "") + path;
}

function authHeaders() {
  const t = document.getElementById("token").value.trim();
  if (!t) return {};
  return { "Authorization": "Bearer " + t };
}

async function readErrorText(resp) {
  // Try JSON first, fallback to text
  try {
    const j = await resp.json();
    return JSON.stringify(j, null, 2);
  } catch (_) {
    try {
      return await resp.text();
    } catch (__) {
      return "(no response body)";
    }
  }
}

async function startUpload() {
  setBusy(true);
  try {
    resetStatus();

    const fileInput = document.getElementById("file");
    const file = fileInput.files[0];

    if (!file) {
      log("‚ùå Please select a PDF.");
      return;
    }

    if (!file.name.toLowerCase().endsWith(".pdf")) {
      log("‚ùå Only PDF files allowed.");
      return;
    }

    const mfr = document.getElementById("mfr").value.trim();
    if (!mfr) {
      log("‚ùå Manufacturer is required.");
      return;
    }

    const series = document.getElementById("series").value.trim();
    const model = document.getElementById("model").value.trim();
    const notes = document.getElementById("notes").value.trim();

    // STEP 1: Get signed URL
    log("1Ô∏è‚É£ Requesting signed URL...");

    const r1 = await fetch(apiUrl("/upload_request"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...authHeaders()
      },
      body: JSON.stringify({
        mfr: mfr,
        filename: file.name,           // ‚úÖ FIXED (was file_name)
        series: series || null,
        model: model || null,
        notes: notes || null
      })
    });

    if (!r1.ok) {
      log("‚ùå upload_request failed: " + r1.status);
      log(await readErrorText(r1));
      return;
    }

    const r1json = await r1.json();
    const signed_url = r1json.signed_url;
    const object_path = r1json.object_path;

    if (!signed_url || !object_path) {
      log("‚ùå Backend did not return signed_url/object_path.");
      log(JSON.stringify(r1json, null, 2));
      return;
    }

    log("‚úÖ Signed URL received.");
    log("   object_path = " + object_path);

    // STEP 2: Upload to GCS
    log("2Ô∏è‚É£ Uploading PDF to storage...");

    const r2 = await fetch(signed_url, {
      method: "PUT",
      headers: { "Content-Type": file.type || "application/pdf" },
      body: file
    });

    if (!r2.ok) {
      log("‚ùå File upload failed: " + r2.status);
      log(await readErrorText(r2));
      return;
    }

    log("‚úÖ PDF uploaded successfully.");

    // STEP 3: Notify backend
    log("3Ô∏è‚É£ Finalizing metadata...");

    const r3 = await fetch(apiUrl("/upload_complete"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...authHeaders()
      },
      body: JSON.stringify({
        object_path: object_path,
        mfr: mfr,
        filename: file.name,
        series: series || null,
        model: model || null,
        notes: notes || null
      })
    });

    if (!r3.ok) {
      log("‚ùå upload_complete failed: " + r3.status);
      log(await readErrorText(r3));
      return;
    }

    const result = await r3.json();
    log("üéâ Upload Complete!");
    log(JSON.stringify(result, null, 2));

  } catch (err) {
    console.error(err);
    log("‚ùå Unexpected error: " + (err?.message || err));
  } finally {
    setBusy(false);
  }
}
</script>

</body>
</html>
